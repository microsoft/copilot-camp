
<!doctype html>
<html lang="ja" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://microsoft.github.io/copilot-camp/ja/pages/custom-engine/agent-framework/06-add-copilot-api/">
      
      
        <link rel="prev" href="../05-add-communication/">
      
      
        <link rel="next" href="../07-add-mcp-tools/">
      
      
        
          <link rel="alternate" href="../../../../../pages/custom-engine/agent-framework/06-add-copilot-api/" hreflang="en">
        
          <link rel="alternate" href="./" hreflang="ja">
        
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>ラボ BAF6 - Microsoft 365 Work IQ API 統合を追加する - Copilot Developer Camp</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../stylesheets/labStyles.css">
    
      <link rel="stylesheet" href="../../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#baf6-microsoft-365-work-iq-api" class="md-skip">
          コンテンツにスキップ
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="ヘッダー">
    <a href="../../../../" title="Copilot Developer Camp" class="md-header__button md-logo" aria-label="Copilot Developer Camp" data-md-component="logo">
      
  <img src="../../../../../assets/images/tent-small.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Copilot Developer Camp
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ラボ BAF6 - Microsoft 365 Work IQ API 統合を追加する
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="言語切り替え">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../../../../../pages/custom-engine/agent-framework/06-add-copilot-api/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="./" hreflang="ja" class="md-select__link">
              Japanese (日本語)
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="検索" placeholder="検索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="検索">
        
        <button type="reset" class="md-search__icon md-icon" title="クリア" aria-label="クリア" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            検索を初期化
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/microsoft/copilot-camp" title="リポジトリへ" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    microsoft/copilot-camp
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="タブ" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../" class="md-tabs__link">
        
  
  
    
  
  ようこそ

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../make/" class="md-tabs__link">
          
  
  
  Maker 向けエージェントの作成

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../extend-m365-copilot/" class="md-tabs__link">
          
  
  
  宣言型エージェントの構築

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  
  カスタム エンジン エージェントの構築

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../beyond-agents/" class="md-tabs__link">
          
  
  
  AI の概念と手法

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../resources/" class="md-tabs__link">
        
  
  
    
  
  動画など

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="ナビゲーション" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../" title="Copilot Developer Camp" class="md-nav__button md-logo" aria-label="Copilot Developer Camp" data-md-component="logo">
      
  <img src="../../../../../assets/images/tent-small.png" alt="logo">

    </a>
    Copilot Developer Camp
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/microsoft/copilot-camp" title="リポジトリへ" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    microsoft/copilot-camp
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ようこそ
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Maker 向けエージェントの作成
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Maker 向けエージェントの作成
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Microsoft 365 Copilot 向けエージェントの作成
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/agent-builder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ MAB - Copilot Studio Lite によるエージェント作成
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/agent-builder/01-first-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ MAB1 - 最初のエージェントの構築
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/copilot-studio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ MCS - Microsoft Copilot Studio の理解
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/copilot-studio/00-prerequisites/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ MCS0 - セットアップ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/copilot-studio/01-first-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab MCS1 - 最初のエージェント
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/copilot-studio/02-topics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ MCS2 - トピックの定義
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/copilot-studio/03-actions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ MCS3 - ツールの定義
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/copilot-studio/04-extending-m365-copilot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ MCS4 - Microsoft 365 Copilot の拡張
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/copilot-studio/05-connectors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ MCS5 - Power Platform カスタム コネクター
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/copilot-studio/06-mcp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ MCS6 - MCP サーバーの利用
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/copilot-studio/07-autonomous/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ MCS7 - Autonomous エージェントの作成
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/copilot-studio/08-rag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ MCS8 - RAG のための Azure AI Search 統合
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/copilot-studio/09-connected-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ MCS9 - Connected エージェント (プレビュー)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/sharepoint-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab MSA - SharePoint エージェントの理解
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/sharepoint-agents/01-first-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ MSA1 - 最初の SharePoint エージェントを構築する
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../make/sharepoint-agents/02-sharing-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab MSA2 - SharePoint エージェントの共有
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    宣言型エージェントの構築
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    宣言型エージェントの構築
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extend-m365-copilot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Microsoft 365 Copilot の拡張
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    セットアップ
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    セットアップ
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extend-m365-copilot/00-prerequisites/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ E0 - セットアップ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    宣言型エージェントの基礎
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    宣言型エージェントの基礎
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extend-m365-copilot/01-typespec-declarative-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ E1 - Microsoft 365 Agents Toolkit で TypeSpec 定義を使って Declarative エージェントを初めて作成する
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extend-m365-copilot/01a-geolocator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ E1 - Geo Locator ゲーム エージェントのインストラクション
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API をゼロから構築して統合
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    API をゼロから構築して統合
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extend-m365-copilot/02-build-the-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ E2 - API の構築
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extend-m365-copilot/03-add-declarative-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ E3 - 宣言型エージェントと API プラグインの追加
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extend-m365-copilot/04-enhance-api-plugin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ E4 - API とプラグインの強化
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extend-m365-copilot/05-add-adaptive-card/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ E5 - Adaptive Card の追加
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extend-m365-copilot/06a-add-authentication-ttk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ E6a - OAuth で Entra ID 認証を追加 (Agents Toolkit)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    インテグレーション
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    インテグレーション
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extend-m365-copilot/07-add-graphconnector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ E7 - 統合: Microsoft Copilot Connector を使用して Trey Genie に Knowledge 機能を追加
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extend-m365-copilot/08-mcp-server/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ 08 : Declarative エージェントを MCP サーバーに接続する
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extend-m365-copilot/09-connected-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ 09: Connected Agent - Zava のマルチ エージェント請求オーケストレーション
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    カスタム エンジン エージェントの構築
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    カスタム エンジン エージェントの構築
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    カスタム エンジン エージェントの構築
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Microsoft Foundry で構築する
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Microsoft Foundry で構築する
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents-sdk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    はじめに - M365 Agents SDK と Semantic Kernel で独自エージェントを構築する
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents-sdk/00-prerequisites/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ BMA0 - 前提条件
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents-sdk/01-agent-in-foundry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ BMA1 - Microsoft Foundry でエージェントを準備する
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents-sdk/02-agent-with-agents-sdk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ BMA2 - M365 Agents SDK を使用した初めてのエージェント構築
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents-sdk/03-agent-configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ BMA3 - Microsoft Foundry エージェントと M365 Agents SDK の統合
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents-sdk/04-bring-agent-to-copilot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ MBA4 - エージェントを Copilot Chat に追加
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" checked>
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Agent Framework で構築する
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Agent Framework で構築する
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Zava Insurance エージェントの構築 - Microsoft 365 Agents SDK と Agents Framework
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../01-build-and-run/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ BAF1 - 最初のエージェントの構築と実行
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../02-add-claim-search/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ BAF2 - Azure AI Search を使用したドキュメント検索の追加
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../03-add-vision-analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ BAF3 - Mistral AI を使用したビジョン解析の追加
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../04-add-policy-search/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ BAF4 - ポリシー検索の追加
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../05-add-communication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ BAF5 - 通信機能の追加
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    ラボ BAF6 - Microsoft 365 Work IQ API 統合を追加する
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ BAF6 - Microsoft 365 Work IQ API 統合を追加する
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目次">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目次
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        概要
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-sharepoint" class="md-nav__link">
    <span class="md-ellipsis">
      
        エクササイズ 1: ポリシー ドキュメント用の SharePoint サイトを準備する
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-languagemodelservice" class="md-nav__link">
    <span class="md-ellipsis">
      
        エクササイズ 2: LanguageModelService を作成する
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-claimspoliciesplugin" class="md-nav__link">
    <span class="md-ellipsis">
      
        エクササイズ 3: ClaimsPoliciesPlugin を作成する
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-claimspoliciesplugin" class="md-nav__link">
    <span class="md-ellipsis">
      
        エクササイズ 4: ClaimsPoliciesPlugin をエージェントに登録する
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-copilot-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        エクササイズ 5: Copilot API 統合をテストする
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../07-add-mcp-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ラボ BAF7 - MCP ツール統合の追加
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    AI の概念と手法
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    AI の概念と手法
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../beyond-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Index
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../beyond-agents/beginner-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    エージェント指示ラボ - エージェント指示の改善 (初心者向け)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    動画など
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="baf6-microsoft-365-work-iq-api">ラボ BAF6 - Microsoft 365 Work IQ API 統合を追加する</h1>
<p>このラボでは、Zava Insurance エージェントに Microsoft 365 Work IQ API を組み込みます。SharePoint のポリシー ドキュメントを <strong>Copilot Retrieval API</strong> 経由で取得し、Microsoft 365 Copilot のエンタープライズ検索のグラウンディング機能を活用して、保険金請求のコンプライアンスを分析できるようにします。</p>
<details class="info" open="open">
<summary>Microsoft 365 Work IQ API の概要</summary>
<p><strong>Microsoft 365 Work IQ API</strong> を使用すると、エージェントは次のことが可能になります:</p>
<ul>
<li><strong>Copilot Retrieval API</strong>: SharePoint、OneDrive、Copilot コネクタから、権限とコンプライアンス設定を尊重しながら関連するテキスト チャンクを取得</li>
<li><strong>Secure Data Access</strong>: 信頼境界内で Microsoft 365 データへアクセスし、データの持ち出しを防止</li>
<li><strong>Enterprise Search Grounding</strong>: Microsoft 365 Copilot と同じ方法で、組織固有情報に基づいて LLM の回答をグラウンディング</li>
<li><strong>Compliance &amp; Security</strong>: 組み込みの権限モデルで厳格なセキュリティ基準を維持</li>
</ul>
<p>これにより、SharePoint に保存されたポリシー ドキュメントと照合して保険金請求のコンプライアンスを分析できます。</p>
</details>
<hr />

<h2 id="_1">概要</h2>
<p>ラボ BAF5 では、メール送信とレポート生成の機能を追加しました。今回は Microsoft 365 Work IQ API を用いて SharePoint からポリシー ドキュメントを取得し、AI を活用して保険金請求のコンプライアンスを分析できるようにエージェントを拡張します。</p>
<p><strong>Copilot Retrieval API</strong> は、データを別途複製・インデックス化・チャンク化・保護することなく Retrieval Augmented Generation (RAG) を実現するシンプルなソリューションを提供します。ユーザーのコンテキストと意図を理解し、クエリを変換して最適な結果を返します。</p>
<details class="warning" open="open">
<summary>ライセンス要件</summary>
<p>Copilot Retrieval API は <strong>Microsoft 365 Copilot アドオン ライセンス</strong> を持つユーザーであれば追加費用なしで利用できます。現在、Microsoft 365 Copilot アドオン ライセンスを持たないユーザーはサポートされていません。</p>
</details>
<h2 id="1-sharepoint">エクササイズ 1: ポリシー ドキュメント用の SharePoint サイトを準備する</h2>
<p>Copilot Retrieval API を使用する前に、ポリシー ドキュメントを格納する SharePoint サイトを作成します。</p>
<h3 id="1-sharepoint_1">手順 1: SharePoint サイトを作成する</h3>
<details class="note">
<summary>SharePoint と Copilot Retrieval API について</summary>
<p><strong>Microsoft Graph Copilot Retrieval API</strong> を使用すると、Microsoft 365 Copilot を支える強力なセマンティック検索を使って SharePoint のコンテンツを検索できます。</p>
<ul>
<li><strong>Semantic Search</strong>: SharePoint ドキュメントを対象に自然言語で検索</li>
<li><strong>Real-time Access</strong>: 常に最新バージョンのドキュメントを検索</li>
<li><strong>Security</strong>: SharePoint の権限を尊重 (ユーザー認証が必須)</li>
<li><strong>Citations</strong>: 出典リンク付きでドキュメント スニペットを返却</li>
</ul>
<p>ポリシー条項、補償ガイド、FAQ ドキュメントの検索に最適です。</p>
</details>
<p>1️⃣ <a href="https://www.office.com/launch/sharepoint" target="_blank">SharePoint</a> にアクセスし、Microsoft 365 アカウントでサインインします。</p>
<p>2️⃣ <strong>+ Create site</strong> をクリック → <strong>Team site</strong> を選択します。</p>
<p>3️⃣ <strong>Standard team</strong> サイト テンプレートを選択し、<strong>Use template</strong> をクリックします。</p>
<p>4️⃣ サイトを設定します:</p>
<ul>
<li><strong>Site name</strong>: "Zava Insurance Policy Documents"</li>
<li><strong>Description</strong>: "Insurance policy terms, coverage guides, and FAQs"</li>
</ul>
<p>5️⃣ <strong>Next</strong> を選択します</p>
<ul>
<li><strong>Privacy settings</strong>: Private (メンバーのみアクセス可)</li>
<li><strong>Select language</strong>: English</li>
</ul>
<p>6️⃣ <strong>Create site</strong> コマンドを選択し、サイトが作成されるまで待機します。</p>
<p>7️⃣ サイトが準備できたら <strong>Finish</strong> を選択してサイトに移動します。</p>
<p><cc-end-step lab="baf6" exercise="1" step="1" /></p>
<h3 id="2">手順 2: ポリシー ドキュメントをアップロードする</h3>
<p>次に、プロジェクトのサンプル ポリシー ドキュメントをアップロードします。</p>
<p>1️⃣ VS Code ワークスペースで <code>src/agent-framework/complete/infra/data/sample-documents/</code> フォルダーを開きます。</p>
<p>2️⃣ 以下のドキュメントがあることを確認します:</p>
<ul>
<li><code>Auto Insurance Claims Policies.docx</code></li>
<li><code>Homeowners Insurance Claims Policies.docx</code></li>
<li><code>Step-by-Step Guide - Creating an Insurance Quote.docx</code></li>
<li><code>Zava Claims Insurance Policies.docx</code></li>
</ul>
<p>3️⃣ SharePoint で新しいサイトを開き、左メニューの <strong>Documents</strong> をクリックします。</p>
<p>4️⃣ <strong>Upload</strong> → <strong>Files</strong> をクリックし、sample-documents フォルダーの 4 つのドキュメントをすべてアップロードします。</p>
<p>5️⃣ SharePoint がドキュメントをインデックス化するまで <strong>10〜15 分</strong> 待ちます。Copilot Retrieval API がドキュメントを検索可能にするための処理時間です。</p>
<div class="admonition tip">
<p class="admonition-title">インデックス化の確認</p>
<p>ドキュメントがインデックス化されたか確認するには:</p>
<ul>
<li>Microsoft 365 Copilot (copilot.microsoft.com) を開く</li>
<li>「私の SharePoint にはどのようなポリシー ドキュメントがありますか?」と質問する</li>
<li>ドキュメントが表示されれば、エージェントで使用可能です</li>
</ul>
</div>
<p>6️⃣ SharePoint サイトの URL をコピーします。後ほどテストで使用します。</p>
<p><cc-end-step lab="baf6" exercise="1" step="2" /></p>
<h2 id="2-languagemodelservice">エクササイズ 2: LanguageModelService を作成する</h2>
<p>ClaimsPoliciesPlugin を作成する前に、AI でコンプライアンス分析を行うための LanguageModelService を実装します。</p>
<h3 id="1-languagemodelservice">手順 1: LanguageModelService を作成する</h3>
<details class="note">
<summary>このサービスが行うこと</summary>
<p><code>LanguageModelService</code> は言語モデル機能への集中アクセスポイントです:</p>
<ul>
<li><strong>Chat Completions</strong>: プロンプトを言語モデルに送り、レスポンスを取得</li>
<li><strong>Configurable Model</strong>: 設定で指定したモデル デプロイメントを使用</li>
<li><strong>Shared Endpoint</strong>: 他の AI サービスと同じ Azure OpenAI エンドポイントを使用</li>
</ul>
<p>このサービスは ClaimsPoliciesPlugin が取得したポリシー ドキュメントと保険金請求を照合し、コンプライアンスを分析する際に使用します。</p>
</details>
<p>1️⃣ <code>src/Services/LanguageModelService.cs</code> に新しいファイルを作成し、次の実装を追加します:</p>
<pre><code class="language-csharp">using Azure;
using Azure.AI.OpenAI;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using OpenAI.Chat;

namespace InsuranceAgent.Services;

/// &lt;summary&gt;
/// Service for language model operations using gpt-4o-mini
/// Provides centralized access to language understanding and text generation capabilities
/// &lt;/summary&gt;
public class LanguageModelService
{
    private readonly ChatClient _chatClient;
    private readonly IConfiguration _configuration;
    private readonly ILogger&lt;LanguageModelService&gt; _logger;

    public LanguageModelService(
        IConfiguration configuration,
        ILogger&lt;LanguageModelService&gt; logger)
    {
        _configuration = configuration;
        _logger = logger;

        // Use shared endpoint and API key with language model for general understanding
        var endpoint = configuration[&quot;AIModels:Endpoint&quot;]
            ?? throw new InvalidOperationException(&quot;AIModels:Endpoint not configured&quot;);
        var apiKey = configuration[&quot;AIModels:ApiKey&quot;]
            ?? throw new InvalidOperationException(&quot;AIModels:ApiKey not configured&quot;);
        var deployment = configuration[&quot;LANGUAGE_MODEL_NAME&quot;] 
            ?? throw new InvalidOperationException(&quot;LANGUAGE_MODEL_NAME not configured&quot;);

        _logger.LogInformation(&quot;🔍 LanguageModelService Configuration:&quot;);
        _logger.LogInformation(&quot;   Endpoint: {Endpoint}&quot;, endpoint);
        _logger.LogInformation(&quot;   Deployment: {DeploymentName}&quot;, deployment);

        var azureClient = new AzureOpenAIClient(new Uri(endpoint), new AzureKeyCredential(apiKey));
        _chatClient = azureClient.GetChatClient(deployment);
    }

    /// &lt;summary&gt;
    /// Completes a chat request with the language model
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;messages&quot;&gt;The chat messages&lt;/param&gt;
    /// &lt;param name=&quot;options&quot;&gt;Optional chat completion options&lt;/param&gt;
    /// &lt;returns&gt;Chat completion response&lt;/returns&gt;
    public async Task&lt;ChatCompletion&gt; CompleteChatAsync(
        IEnumerable&lt;ChatMessage&gt; messages, 
        ChatCompletionOptions? options = null)
    {
        try
        {
            _logger.LogDebug(&quot;Sending chat completion request with {MessageCount} messages&quot;, messages.Count());

            var response = await _chatClient.CompleteChatAsync(messages, options);

            _logger.LogDebug(&quot;Received chat completion response&quot;);

            return response.Value;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, &quot;Error completing chat request&quot;);
            throw;
        }
    }

    /// &lt;summary&gt;
    /// Gets the underlying ChatClient for advanced scenarios
    /// &lt;/summary&gt;
    public ChatClient ChatClient =&gt; _chatClient;
}
</code></pre>
<p><cc-end-step lab="baf6" exercise="2" step="1" /></p>
<h3 id="2-languagemodelservice_1">手順 2: 依存関係注入に LanguageModelService を登録する</h3>
<p>アプリケーションの DI コンテナーにサービスを登録します。</p>
<p>1️⃣ <code>src/Program.cs</code> を開きます。</p>
<p>2️⃣ 他のサービスを登録している箇所 (例: <code>builder.Services.AddScoped&lt;VisionService&gt;();</code>) を見つけ、その直後に以下を追加します:</p>
<pre><code class="language-csharp">// Register LanguageModelService for AI-powered analysis
builder.Services.AddSingleton&lt;LanguageModelService&gt;();
</code></pre>
<p><cc-end-step lab="baf6" exercise="2" step="2" /></p>
<h3 id="3">手順 3: 設定を更新する</h3>
<p>言語モデルの設定が含まれていることを確認します。</p>
<p>1️⃣ <code>.env.local</code> ファイルを開きます。</p>
<p>2️⃣ 次の言語モデル設定があるか確認し、無ければ追加します:</p>
<pre><code class="language-bash"># Language Model (for compliance analysis)
LANGUAGE_MODEL_NAME=gpt-4o
</code></pre>
<details class="note">
<summary>設定に関する補足</summary>
<ul>
<li><strong>LANGUAGE_MODEL_NAME</strong>: Azure OpenAI での言語モデルのデプロイ名</li>
<li>サービスは他の AI モデルと同じエンドポイントと API キーを使用します</li>
<li>コスト重視の場合は <code>gpt-4o-mini</code>、高度な推論が必要な場合は <code>gpt-4o</code> を利用できます</li>
</ul>
</details>
<p><cc-end-step lab="baf6" exercise="2" step="3" /></p>
<h2 id="3-claimspoliciesplugin">エクササイズ 3: ClaimsPoliciesPlugin を作成する</h2>
<p>Copilot Retrieval API を使用して、SharePoint のポリシー ドキュメントと照合し保険金請求のコンプライアンスを分析する ClaimsPoliciesPlugin を作成します。</p>
<h3 id="1-copilot-retrieval-api">手順 1: Copilot Retrieval API を理解する</h3>
<details class="note">
<summary>Copilot Retrieval API の仕組み</summary>
<p><strong>Microsoft 365 Copilot Retrieval API</strong> では次のことが可能です:</p>
<ul>
<li><strong>Query SharePoint content</strong>: 自然言語クエリで SharePoint ドキュメントから関連テキストを取得</li>
<li><strong>Respect permissions</strong>: ユーザーのアクセス権に基づいて結果をフィルタリング</li>
<li><strong>Get structured responses</strong>: タイトルや著者などのメタデータ付きテキスト抽出結果を受信</li>
<li><strong>Use KQL filters</strong>: URL、日付範囲、ファイル タイプなどでフィルタリング可能</li>
</ul>
<p><strong>API エンドポイント</strong>: <code>POST https://graph.microsoft.com/v1.0/copilot/retrieval</code></p>
<p><strong>リクエスト ペイロード</strong>:</p>
<p><code>json
{
    "queryString": "Your natural language query",
    "dataSource": "SharePoint",
    "resourceMetadata": ["title", "author"]
}</code></p>
<p><strong>ベスト プラクティス</strong>:</p>
<ul>
<li>クエリには可能な限り多くのコンテキストを含める</li>
<li><code>queryString</code> は 1 文にまとめる</li>
<li>幅広い内容に当てはまる一般的すぎるクエリは避ける</li>
<li>返されたすべての抽出テキストを LLM へ渡して回答を生成する</li>
</ul>
</details>
<p><cc-end-step lab="baf6" exercise="3" step="1" /></p>
<h3 id="2-claimspoliciesplugin">手順 2: ClaimsPoliciesPlugin を作成する</h3>
<details class="note">
<summary>このプラグインが行うこと</summary>
<p><code>ClaimsPoliciesPlugin</code> は保険金請求のコンプライアンス分析機能を提供します。</p>
<p><strong>AnalyzeClaimCompliance</strong>:</p>
<ul>
<li>KnowledgeBaseService から請求詳細を取得</li>
<li>Copilot Retrieval API で SharePoint のポリシー ドキュメントを検索</li>
<li>AI を使って請求内容とポリシーを照合しコンプライアンスを分析</li>
<li>出典付きの構造化された分析結果を返却</li>
<li>ストリーミング レスポンスに SharePoint ドキュメントの引用を追加</li>
</ul>
<p>プラグインは <strong>On-Behalf-Of (OBO) トークン</strong> を使用して Microsoft Graph を呼び出し、ユーザー権限を尊重します。</p>
</details>
<p>1️⃣ <code>src/Plugins/ClaimsPoliciesPlugin.cs</code> に次の実装を持つ新しいファイルを作成します:</p>
<pre><code class="language-csharp">using Microsoft.Agents.Builder;
using Microsoft.Agents.Core.Models;
using System.ComponentModel;
using System.Text.Json;
using InsuranceAgent;
using Microsoft.Agents.Builder.State;
using InsuranceAgent.Services;
using Azure.Search.Documents.Models;
using OpenAI.Chat;

namespace ZavaInsurance.Plugins
{
    /// &lt;summary&gt;
    /// Claims Policies Plugin for Zava Insurance
    /// Provides tools for analyzing claim compliance using Copilot Retrieval API
    /// Retrieves policy documents from SharePoint and uses AI for compliance analysis
    /// &lt;/summary&gt;
    public class ClaimsPoliciesPlugin
    {
        private readonly ITurnContext _turnContext;
        private readonly ITurnState _turnState;
        private readonly HttpClient _httpClient;
        private readonly KnowledgeBaseService _knowledgeBaseService;
        private readonly LanguageModelService _languageModelService;
        private readonly IConfiguration _configuration;

        public ClaimsPoliciesPlugin(ITurnContext turnContext, 
            ITurnState turnState,
            KnowledgeBaseService knowledgeBaseService,
            LanguageModelService languageModelService,
            IConfiguration configuration, 
            HttpClient httpClient)
        {
            _turnContext = turnContext ?? throw new ArgumentNullException(nameof(turnContext));
            _turnState = turnState ?? throw new ArgumentNullException(nameof(turnState));
            _knowledgeBaseService = knowledgeBaseService ?? throw new ArgumentNullException(nameof(knowledgeBaseService));
            _languageModelService = languageModelService ?? throw new ArgumentNullException(nameof(languageModelService));
            _configuration = configuration ?? throw new ArgumentNullException(nameof(configuration));
            _httpClient = httpClient ?? throw new ArgumentNullException(nameof(httpClient));
        }

        /// &lt;summary&gt;
        /// Retrieves claims policies from SharePoint Online using Copilot Retrieval APIs and analyzes claim compliance
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;claimId&quot;&gt;The unique claim identifier&lt;/param&gt;
        /// &lt;returns&gt;The claim compliance with policies&lt;/returns&gt;
        [Description(&quot;Retrieves claims policies from SharePoint Online using Copilot Retrieval APIs and analyzes claim compliance&quot;)]
        public async Task&lt;string&gt; AnalyzeClaimCompliance(string claimId)
        {
            await NotifyUserAsync($&quot;Retrieving policies for claim {claimId}...&quot;);

            // Read the user profile and OBO token from conversation state
            var userProfile = _turnState.Conversation.GetCachedUserProfile();
            var accessToken = _turnState.Conversation.GetCachedOBOAccessToken();

            // Use direct search to get structured data (more reliable than Knowledge Base answer synthesis)
            var claimDoc = await _knowledgeBaseService.GetClaimByNumberAsync(claimId);

            if (claimDoc == null)
            {
                return $&quot;❌ Claim {claimId} not found in the system.&quot;;
            }

            try
            {
                // Build the Copilot Retrieval API request payload
                var retrievalPayload = new
                {
                    queryString = $&quot;Retrieve the claims policies for claims of type '{GetFieldValue(claimDoc, &quot;claimType&quot;)}' in region '{GetFieldValue(claimDoc, &quot;region&quot;)}'&quot;,
                    dataSource = &quot;SharePoint&quot;,
                    resourceMetadata = new[] { &quot;title&quot;, &quot;author&quot; }
                };

                var jsonContent = JsonSerializer.Serialize(retrievalPayload);
                var httpContent = new StringContent(jsonContent, System.Text.Encoding.UTF8, &quot;application/json&quot;);

                // Configure HTTP client with OBO token
                _httpClient.DefaultRequestHeaders.Clear();
                _httpClient.DefaultRequestHeaders.Add(&quot;Authorization&quot;, $&quot;Bearer {accessToken}&quot;);
                _httpClient.DefaultRequestHeaders.Add(&quot;Accept&quot;, &quot;application/json&quot;);

                await NotifyUserAsync($&quot;Using Copilot Retrieval APIs to fetch policies from SharePoint...&quot;);

                // Call the Microsoft 365 Copilot Retrieval API
                var response = await _httpClient.PostAsync(&quot;https://graph.microsoft.com/v1.0/copilot/retrieval&quot;, httpContent);

                if (response.IsSuccessStatusCode)
                {
                    await NotifyUserAsync($&quot;✅ Policies successfully retrieved from SharePoint!&quot;);
                }
                else
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    await NotifyUserAsync($&quot;❌ Failed to retrieve policies: {response.StatusCode}&quot;);
                    return $&quot;❌ Error retrieving policies from SharePoint: {response.StatusCode} - {errorContent}&quot;;
                }

                var policiesContent = await response.Content.ReadAsStringAsync();
                var estimatedCost = GetFieldValue(claimDoc, &quot;estimatedCost&quot;);
                var isComplete = GetFieldValue(claimDoc, &quot;isDocumentationComplete&quot;);
                var missingDocs = GetFieldValue(claimDoc, &quot;missingDocumentation&quot;);

                // Build AI prompt for compliance analysis
                var prompt = $@&quot;You are an insurance claims expert and you need to analyze the claim policies for a specific claim.

                    **CLAIM DETAILS:**
                    - Claim Number: {GetFieldValue(claimDoc, &quot;claimNumber&quot;)}
                    - Claim Type: {GetFieldValue(claimDoc, &quot;claimType&quot;)}
                    - Region: {GetFieldValue(claimDoc, &quot;region&quot;)}
                    - Amount: ${estimatedCost:N2}
                    - Status: {GetFieldValue(claimDoc, &quot;status&quot;)}
                    - Severity: {GetFieldValue(claimDoc, &quot;severity&quot;)}
                    - Description: {GetFieldValue(claimDoc, &quot;description&quot;)}
                    - Policy Number: {GetFieldValue(claimDoc, &quot;policyNumber&quot;)}
                    - Policyholder: {GetFieldValue(claimDoc, &quot;policyholderName&quot;)}
                    - Assigned Adjuster: {GetFieldValue(claimDoc, &quot;assignedAdjuster&quot;)}
                    - Documentation Complete: {(isComplete == &quot;True&quot; || isComplete == &quot;true&quot; ? &quot;Yes&quot; : &quot;No&quot;)}
                    - Missing Documentation: {(string.IsNullOrWhiteSpace(missingDocs) ? &quot;None&quot; : missingDocs)}

                    Here are the claim policies retrieved from SharePoint in JSON format:
                    {policiesContent}

                    Provide analysis in this JSON format:
                    {{
                    &quot;&quot;complianceScore&quot;&quot;: &lt;0-100&gt;,
                    &quot;&quot;complianceLevel&quot;&quot;: &quot;&quot;&lt;Low/Medium/High/Critical&gt;&quot;&quot;,
                    &quot;&quot;analysis&quot;&quot;: &quot;&quot;&lt;detailed explanation of claim compliance with policies&gt;&quot;&quot;,
                    &quot;&quot;keyIndicators&quot;&quot;: [&quot;&quot;&lt;list of specific compliance indicators with references citations to policies using the [1], [2], ... [n] format&gt;&quot;&quot;],
                    &quot;&quot;recommendations&quot;&quot;: [&quot;&quot;&lt;recommended actions&gt;&quot;&quot;],
                    &quot;&quot;citationsTitles&quot;&quot;: [&quot;&quot;&lt;list of titles corresponding to the citations&gt;&quot;&quot;],
                    &quot;&quot;citationsLinks&quot;&quot;: [&quot;&quot;&lt;list of URLs corresponding to the citations&gt;&quot;&quot;]
                    }}

                    &quot;;

                await NotifyUserAsync($&quot;🤖 Running AI compliance analysis...&quot;);

                Console.WriteLine($&quot;🔍 ClaimsPoliciesPlugin.AnalyzeClaimCompliance calling LanguageModelService with Temperature=0.2&quot;);

                // Use AI to analyze compliance
                var messages = new List&lt;ChatMessage&gt;
                {
                    new UserChatMessage(prompt)
                };

                var chatOptions = new ChatCompletionOptions
                {
                    Temperature = 0.2f,
                    ResponseFormat = ChatResponseFormat.CreateJsonObjectFormat()
                };

                var chatResponse = await _languageModelService.CompleteChatAsync(messages, chatOptions);
                var analysisJson = chatResponse.Content[0].Text ?? &quot;{}&quot;;

                var complianceResult = JsonSerializer.Deserialize&lt;ComplianceAnalysisResult&gt;(analysisJson, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

                if (complianceResult == null)
                {
                    return $&quot;❌ Error: Unable to parse compliance analysis for claim {claimId}.&quot;;
                }

                await NotifyUserAsync($&quot;✅ Compliance analysis complete. Compliance Score: {complianceResult.ComplianceScore}/100&quot;);

                // Add citations to streaming response
                for (int i = 0; i &lt; complianceResult.CitationsTitles.Count; i++)
                {
                    var citationTitle = complianceResult.CitationsTitles.Count &gt; i ? complianceResult.CitationsTitles[i] : $&quot;Policy Document {i + 1}&quot;;
                    var citationLink = complianceResult.CitationsLinks.Count &gt; i ? complianceResult.CitationsLinks[i] : null;
                    citationLink = citationLink != null ? GetCitationUrl(citationLink) : citationLink;

                    _turnContext.StreamingResponse.AddCitation(
                        new ClientCitation(
                            position: i + 1,
                            title: citationTitle,
                            abstractText: &quot;Claims Policy&quot;,
                            text: &quot;Claims Policy&quot;,
                            keywords: null,
                            citationLink: citationLink,
                            imageName: ClientCitationsIconNameEnum.MicrosoftWord,
                            useDefaultAdaptiveCard: true));

                    Console.WriteLine($&quot;🔗 Added citation for \&quot;{citationTitle}\&quot; with link {citationLink ?? &quot;[no link]&quot;}&quot;);
                }

                // Format the response
                return $&quot;🚨 **Compliance Analysis for {claimId}**\n\n&quot; +
                       $&quot;**Compliance Score:** {complianceResult.ComplianceScore}/100\n&quot; +
                       $&quot;**Compliance Level:** {complianceResult.ComplianceLevel}\n\n&quot; +
                       $&quot;**Analysis:**\n{complianceResult.Analysis}\n\n&quot; +
                       (complianceResult.KeyIndicators != null &amp;&amp; complianceResult.KeyIndicators.Count &gt; 0
                           ? $&quot;**Key Compliance Indicators:**\n{string.Join(&quot;\n&quot;, complianceResult.KeyIndicators.Select(i =&gt; $&quot;• {i}&quot;))}\n\n&quot;
                           : &quot;&quot;) +
                       (complianceResult.Recommendations != null &amp;&amp; complianceResult.Recommendations.Count &gt; 0
                           ? $&quot;**Recommendations:**\n{string.Join(&quot;\n&quot;, complianceResult.Recommendations.Select(r =&gt; $&quot;• {r}&quot;))}\n\n&quot;
                           : &quot;&quot;);
            }
            catch (Exception ex)
            {
                Console.WriteLine($&quot;❌ Error analyzing claim compliance: {ex.Message}&quot;);
                return $&quot;❌ Error analyzing claim compliance: {ex.Message}&quot;;
            }
        }

        /// &lt;summary&gt;
        /// Helper method to safely extract field values from SearchDocument
        /// &lt;/summary&gt;
        private string GetFieldValue(SearchDocument doc, string fieldName)
        {
            if (doc.ContainsKey(fieldName) &amp;&amp; doc[fieldName] != null)
            {
                return doc[fieldName].ToString() ?? &quot;Not available&quot;;
            }
            return &quot;Not available&quot;;
        }

        // Helper method to construct citation URL through the bot's proxy endpoint
        private string GetCitationUrl(string targetUrl)
        {
            var botEndpoint = _configuration[&quot;BOT_ENDPOINT&quot;];

            Console.WriteLine($&quot;🔍 BOT_ENDPOINT from config: {botEndpoint ?? &quot;NULL&quot;}&quot;);

            if (string.IsNullOrEmpty(botEndpoint))
            {
                var botDomain = _configuration[&quot;BOT_DOMAIN&quot;];
                if (!string.IsNullOrEmpty(botDomain))
                {
                    botEndpoint = $&quot;https://{botDomain}&quot;;
                    Console.WriteLine($&quot;🔍 Using BOT_DOMAIN: {botEndpoint}&quot;);
                }
                else
                {
                    botEndpoint = &quot;http://localhost:3978&quot;;
                    Console.WriteLine($&quot;⚠️ Falling back to localhost&quot;);
                }
            }

            botEndpoint = botEndpoint.TrimEnd('/');
            var citationUrl = $&quot;{botEndpoint}/api/citation?targetUrl={Uri.EscapeDataString(targetUrl)}&quot;;
            Console.WriteLine($&quot;⚙️ Generated citation URL: {citationUrl}&quot;);

            return citationUrl;
        }

        // Helper method to notify user via streaming
        private async Task NotifyUserAsync(string message)
        {
            if (!_turnContext.Activity.ChannelId.Channel!.Contains(Channels.Webchat))
            {
                await _turnContext.StreamingResponse.QueueInformativeUpdateAsync(message);
            }
            else
            {
                await _turnContext.StreamingResponse.QueueInformativeUpdateAsync(message).ConfigureAwait(false);
            }
        }
    }

    /// &lt;summary&gt;
    /// Result of AI-powered compliance analysis
    /// &lt;/summary&gt;
    public class ComplianceAnalysisResult
    {
        public int ComplianceScore { get; set; }
        public string ComplianceLevel { get; set; } = &quot;&quot;;
        public string Analysis { get; set; } = &quot;&quot;;
        public List&lt;string&gt; KeyIndicators { get; set; } = new();
        public List&lt;string&gt; Recommendations { get; set; } = new();
        public List&lt;string&gt; CitationsTitles { get; set; } = new();
        public List&lt;string&gt; CitationsLinks { get; set; } = new();
    }
}
</code></pre>
<details class="info" open="open">
<summary>StreamingResponse での引用の仕組み</summary>
<p><code>ClaimsPoliciesPlugin</code> は <code>ITurnContext</code> 上の <code>StreamingResponse.AddCitation()</code> メソッドを使用して引用をレスポンスに追加します。手順は以下のとおりです:</p>
<ol>
<li>
<p><strong>AI が引用参照を生成</strong>: 言語モデルが分析テキスト内に <code>[1]</code>, <code>[2]</code> などの参照と <code>CitationsTitles</code>, <code>CitationsLinks</code> 配列を返します。</p>
</li>
<li>
<p><strong>ClientCitation オブジェクトを作成</strong>: 各引用について <code>ClientCitation</code> を作成します:</p>
<ul>
<li><code>position</code>: 引用番号 (1 から始まり、テキスト内の <code>[1]</code>, <code>[2]</code> と一致)</li>
<li><code>title</code>: 表示用タイトル</li>
<li><code>citationLink</code>: ソース ドキュメントへの URL (ボットのプロキシ エンドポイント経由)</li>
<li><code>imageName</code>: アイコン (例: <code>ClientCitationsIconNameEnum.MicrosoftWord</code>)</li>
</ul>
</li>
<li>
<p><strong>StreamingResponse に追加</strong>: <code>_turnContext.StreamingResponse.AddCitation(citation)</code> を呼び出して引用をキューに追加します。</p>
</li>
<li>
<p><strong>M365 Copilot が引用を表示</strong>: Microsoft 365 Copilot がクリック可能な引用リンクを自動でレンダリングします。</p>
</li>
</ol>
<p><strong>プロキシ エンドポイントを使う理由</strong>: SharePoint の URL は認証が必要なため、<code>GetCitationUrl()</code> でボットの <code>/api/citation</code> エンドポイントを経由させ、認証後に実際のドキュメントへリダイレクトします。</p>
</details>
<p><cc-end-step lab="baf6" exercise="3" step="2" /></p>
<h2 id="4-claimspoliciesplugin">エクササイズ 4: ClaimsPoliciesPlugin をエージェントに登録する</h2>
<p>ZavaInsuranceAgent に ClaimsPoliciesPlugin を組み込みます。</p>
<h3 id="1-claimspoliciesplugin">手順 1: ClaimsPoliciesPlugin をインスタンス化する</h3>
<p>1️⃣ <code>src/Agent/ZavaInsuranceAgent.cs</code> を開きます。</p>
<p>2️⃣ <code>GetClientAgent</code> メソッド (約 169 行目) を探します。</p>
<p>3️⃣ サービス インスタンスを取得している箇所で、<code>var visionService = scope.ServiceProvider.GetRequiredService&lt;VisionService&gt;();</code> の直後に次を追加します:</p>
<pre><code class="language-csharp">var languageModelService = scope.ServiceProvider.GetRequiredService&lt;LanguageModelService&gt;();
</code></pre>
<p>4️⃣ プラグインをインスタンス化している場所 (<code>CommunicationPlugin communicationPlugin = ...</code> の後) を探します。</p>
<p>5️⃣ ClaimsPoliciesPlugin のインスタンス化を追加します:</p>
<pre><code class="language-csharp">// Create ClaimsPoliciesPlugin with required dependencies
ClaimsPoliciesPlugin claimsPoliciesPlugin = new(context, turnState, knowledgeBaseService, languageModelService, configuration, httpClient);
</code></pre>
<p><cc-end-step lab="baf6" exercise="4" step="1" /></p>
<h3 id="2-claimspoliciesplugin_1">手順 2: ClaimsPoliciesPlugin のツールを登録する</h3>
<p>同じ <code>GetClientAgent</code> メソッドで、<code>toolOptions.Tools</code> にツールを追加している箇所までスクロールします。</p>
<p>Communication ツール セクションを見つけ、その直後に ClaimsPoliciesPlugin ツールを追加します:</p>
<pre><code class="language-csharp">// Register ClaimsPolicies tools (Copilot Retrieval API)
toolOptions.Tools.Add(AIFunctionFactory.Create(claimsPoliciesPlugin.AnalyzeClaimCompliance));
</code></pre>
<details class="note">
<summary>ツール登録パターン</summary>
<p>エージェントは <strong>AIFunctionFactory</strong> を使用してプラグイン メソッドを AI ツールとして登録します。プラグイン メソッドの <code>[Description]</code> 属性がツールの説明となり、LLM が呼び出し判断を行います。</p>
</details>
<p><cc-end-step lab="baf6" exercise="4" step="2" /></p>
<h3 id="3_1">手順 3: エージェントの命令文を更新する</h3>
<p>コンプライアンス分析ツールを命令文に追加します。</p>
<p>1️⃣ <code>src/Agent/ZavaInsuranceAgent.cs</code> で <code>AgentInstructions</code> フィールドを探します。</p>
<p>2️⃣ 既存のツール一覧を見つけ、次を追加します:</p>
<pre><code class="language-csharp">For claims compliance analysis, use {{ClaimsPoliciesPlugin.AnalyzeClaimCompliance}}.
</code></pre>
<p><code>AgentInstructions</code> 全体は以下のようにすべてのツールを含む必要があります:</p>
<pre><code class="language-csharp">private readonly string AgentInstructions = &quot;&quot;&quot;
You are a professional insurance claims assistant for Zava Insurance.

Whenever the user starts a new conversation or provides a prompt to start a new conversation like &quot;start over&quot;, &quot;restart&quot;, 
&quot;new conversation&quot;, &quot;what can you do?&quot;, &quot;how can you help me?&quot;, etc. use {{StartConversationPlugin.StartConversation}} and 
provide to the user exactly the message you get back from the plugin.

**Available Tools:**
Use {{DateTimeFunctionTool.getDate}} to get the current date and time.
For claims search, use {{ClaimsPlugin.SearchClaims}} and {{ClaimsPlugin.GetClaimDetails}}.
For damage photo viewing, use {{VisionPlugin.ShowDamagePhoto}}.
For AI vision damage analysis, use {{VisionPlugin.AnalyzeAndShowDamagePhoto}} and require approval via {{VisionPlugin.ApproveAnalysis}}.
For policy search, use {{PolicyPlugin.SearchPolicies}} and {{PolicyPlugin.GetPolicyDetails}}.
For sending investigation reports and claim details via email, use {{CommunicationPlugin.GenerateInvestigationReport}} and {{CommunicationPlugin.SendClaimDetailsByEmail}}.
For claims compliance analysis, use {{ClaimsPoliciesPlugin.AnalyzeClaimCompliance}}.

**IMPORTANT**: When user asks to &quot;check policy for this claim&quot;, first use GetClaimDetails to get the claim's policy number, then use GetPolicyDetails with that policy number.

**IMPORTANT**: If in the response there are references to citations like [1], [2], etc., make sure to include those citations in the response so that M365 Copilot can render them properly.

Stick to the scenario above and use only the information from the tools when answering questions.
Be concise and professional in your responses.
&quot;&quot;&quot;;
</code></pre>
<p><cc-end-step lab="baf6" exercise="4" step="3" /></p>
<h3 id="4">手順 4: ウェルカム メッセージを更新する</h3>
<p>StartConversationPlugin にコンプライアンス分析を提案フローとして追加します。</p>
<p>1️⃣ <code>src/Plugins/StartConversationPlugin.cs</code> を開きます。</p>
<p>2️⃣ <code>StartConversation</code> メソッド内の <code>welcomeMessage</code> 変数を探します。</p>
<p>3️⃣ ワークフロー一覧で "Analyze this damage photo" の後に次を追加します:</p>
<pre><code class="language-csharp">&quot;8. \&quot;Check compliance for this claim\&quot;\n&quot; +
</code></pre>
<p>4️⃣ 以降の手順番号を更新します (Generate investigation report → 9、Update claim status → 10)。</p>
<p>更新後のワークフロー セクションは次のようになります:</p>
<pre><code class="language-csharp">&quot;🎯 Try this complete investigation workflow:\n&quot; +
&quot;1. \&quot;Get details for claim CLM-2025-001007\&quot;\n&quot; +
&quot;2. \&quot;Check policy for this claim\&quot;\n&quot; +
&quot;3. \&quot;What coverage does auto insurance include?\&quot;\n&quot; +
&quot;4. \&quot;Analyze fraud risk for this claim\&quot;\n&quot; +
&quot;5. \&quot;Show damage photo for this claim\&quot;\n&quot; +
&quot;6. \&quot;Analyze this damage photo\&quot;\n&quot; +
&quot;7. \&quot;What's the claims filing procedure?\&quot;\n&quot; +
&quot;8. \&quot;Check compliance for this claim\&quot;\n&quot; +
&quot;9. \&quot;Generate investigation report for claim CLM-2025-001007\&quot;\n&quot; +
&quot;10. \&quot;Update claim status to 'Approved for Payment'\&quot;\n\n&quot; +
</code></pre>
<p><cc-end-step lab="baf6" exercise="4" step="4" /></p>
<h2 id="5-copilot-api">エクササイズ 5: Copilot API 統合をテストする</h2>
<p>統合が完了したら、実際に動作を確認します。</p>
<h3 id="1">手順 1: 実行して確認する</h3>
<p>1️⃣ VS Code で <strong>F5</strong> を押してデバッグを開始します。</p>
<p>2️⃣ プロンプトが表示されたら <strong>(Preview) Debug in Copilot (Edge)</strong> を選択します。</p>
<p>3️⃣ ターミナルに通常の初期化メッセージが表示されます。</p>
<p>4️⃣ ブラウザーで Microsoft 365 Copilot が開きます。</p>
<p><cc-end-step lab="baf6" exercise="5" step="1" /></p>
<h3 id="2_1">手順 2: 保険金請求のコンプライアンス分析をテストする</h3>
<p>1️⃣ Microsoft 365 Copilot で次を入力します:</p>
<pre><code class="language-text">Check compliance for claim CLM-2025-001007
</code></pre>
<p>エージェントは以下を行うはずです:</p>
<ul>
<li><code>ClaimsPoliciesPlugin.AnalyzeClaimCompliance</code> を使用</li>
<li>Table Storage から請求詳細を取得</li>
<li>Copilot Retrieval API で SharePoint からポリシーを取得</li>
<li>AI でコンプライアンスを分析</li>
<li>出典付きの構造化レポートを返却</li>
</ul>
<p><strong>期待される応答</strong>:</p>
<pre><code>Retrieving policies for claim CLM-2025-001007...
Using Copilot Retrieval APIs to fetch policies from SharePoint...
✅ Policies successfully retrieved from SharePoint!
🤖 Running AI compliance analysis...
✅ Compliance analysis complete. Compliance Score: 85/100

## 📋 Compliance Analysis for Claim CLM-2025-001007

**Compliance Score**: 40/100 (High)
**Compliance Level**: Low

### Analysis
The claim is currently open and has a high severity rating due to a multi-vehicle...

### Key Compliance Indicators
- Incomplete documentation [1]
- High severity claim requires thorough investigation [2]
- ...

### Recommendations
- Contact the policyholder, Arnel Cruz, to gather missing documentation related to the accident.
- ...
</code></pre>
<p>2️⃣ レスポンス内の <strong>引用</strong> (例: <code>[1]</code>, <code>[2]</code>) に注目してください。これらは分析に使用された SharePoint のポリシー ドキュメントへリンクしています。</p>
<p><cc-end-step lab="baf6" exercise="5" step="2" /></p>
<h3 id="3_2">手順 3: 別の請求でテストする</h3>
<p>1️⃣ 別の請求で次のプロンプトを試します:</p>
<pre><code class="language-text">Check if claim CLM-2025-001001 follows our policies
</code></pre>
<p>2️⃣ エージェントは請求の種別 (Auto、Homeowners など) と地域に基づき、適切なポリシーを取得して分析します。</p>
<p><cc-end-step lab="baf6" exercise="5" step="3" /></p>
<h3 id="4_1">手順 4: コンプライアンスを含む完全なワークフローをテストする</h3>
<p>次のプロンプトでワークフロー全体をテストします:</p>
<pre><code class="language-text">1. Get details for claim CLM-2025-001007
2. Check policy for this claim
3. Analyze fraud risk for this claim
4. Check compliance for this claim
5. Generate investigation report for this claim
6. Send the report by email
</code></pre>
<p>エージェントは Copilot Retrieval API を含むすべての機能をシームレスに統合して実行するはずです。</p>
<p><cc-end-step lab="baf6" exercise="5" step="4" /></p>
<p><span style="font-size: large; font-weight: bold; color: #8d57c2;">おめでとうございます！</span></p>
<p>Microsoft 365 Work IQ API 統合を追加するラボ BAF6 を完了しました!</p>
<p>このラボで学んだこと:</p>
<ul>
<li>✅ Copilot Retrieval API 用にポリシー ドキュメントを格納する SharePoint サイトを構築</li>
<li>✅ AI 処理用に集中管理された LanguageModelService を作成</li>
<li>✅ Microsoft 365 Copilot Retrieval API とその機能を理解</li>
<li>✅ Copilot Retrieval API を利用する ClaimsPoliciesPlugin を作成</li>
<li>✅ Microsoft Graph 経由で SharePoint ポリシー ドキュメント検索を統合</li>
<li>✅ 取得したポリシー ドキュメントを用いた AI 分析を実装</li>
<li>✅ SharePoint ドキュメントの引用をエージェント回答に追加</li>
</ul>
<p>あなたの Zava Insurance エージェントには、次の機能が含まれました:</p>
<ul>
<li><strong>Search</strong>: Azure AI Search による請求とポリシーの検索</li>
<li><strong>Analysis</strong>: Mistral を用いた AI ビジョンでの損害評価</li>
<li><strong>Compliance</strong>: SharePoint のポリシーを用いた Copilot Retrieval API によるコンプライアンス分析</li>
<li><strong>Communication</strong>: メール レポートと調査サマリー</li>
</ul>
<details class="info" open="open">
<summary>Microsoft 365 Work IQ API について</summary>
<p>Microsoft 365 Work IQ API は、Copilot の体験を支えるコンポーネントへのアクセスを提供します:</p>
<ul>
<li><strong>Retrieval API</strong>: Microsoft 365 データを持ち出さずに AI ソリューションをグラウンディング</li>
<li><strong>Chat API</strong> (プレビュー): エンタープライズ検索のグラウンディング付きでマルチターン会話を実現</li>
</ul>
<p>これらの API は、データをその場に保持し、権限を尊重することで厳格なセキュリティとコンプライアンスを維持します。</p>
</details>
<p>🎉 <strong>おめでとうございます!</strong> Microsoft 365 Copilot API を統合した本番レベルの AI エージェントが完成しました! 🎊</p>
<p><img src="https://m365-visitor-stats.azurewebsites.net/copilot-camp/custom-engine/agent-framework/06-add-copilot-api--ja" /></p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "toc.integrate", "content.code.copy"], "search": "../../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f", "clipboard.copy": "\u30af\u30ea\u30c3\u30d7\u30dc\u30fc\u30c9\u3078\u30b3\u30d4\u30fc", "search.result.more.one": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3082\u30461\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.more.other": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3042\u3068#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.none": "\u4f55\u3082\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f", "search.result.one": "1\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.other": "#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.placeholder": "\u691c\u7d22\u30ad\u30fc\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044", "search.result.term.missing": "\u691c\u7d22\u306b\u542b\u307e\u308c\u306a\u3044", "select.version": "\u30d0\u30fc\u30b8\u30e7\u30f3\u5207\u308a\u66ff\u3048"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../../../../javascripts/cc-award.js"></script>
      
        <script src="../../../../../javascripts/cc-next.js"></script>
      
        <script src="../../../../../javascripts/cc-lab-step.js"></script>
      
        <script src="../../../../../javascripts/cc-card.js"></script>
      
    
  </body>
</html>